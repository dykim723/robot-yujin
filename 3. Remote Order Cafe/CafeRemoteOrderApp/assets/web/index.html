<!doctype html>
<html>
<head>
    <title>Cafe Solution</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">


    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD73mlF5amwPZAF3SR1kzP7Jpvre6_wxdI&sensor=false"></script>
    <!--<script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>-->

    <script src="file:///android_asset/web/lib/jquery-1.11.0.min.js"></script>
    <script src="file:///android_asset/web/lib/jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.js"></script>
    <script src="file:///android_asset/web/lib/moment-with-langs.min.js"></script>
    <script src="file:///android_asset/web/lib/roslibjs-devel/include/EventEmitter2/eventemitter2.js"></script>
    <script src="file:///android_asset/web/lib/roslibjs-devel/build/roslib.js"></script>
    <link rel="stylesheet" href="file:///android_asset/web/lib/jquery.mobile-1.4.2/jquery.mobile-1.4.2.css">
    <link rel="stylesheet" href="file:///android_asset/web/lib/jquery.mobile-1.4.2/jquery.mobile.icons-1.4.2.min.css">
    <link rel="stylesheet" href="file:///android_asset/web/lib/jquery.mobile-1.4.2/jquery.mobile.structure-1.4.2.min.css">
    <!--<script src="./lib/jquery-1.11.0.min.js"></script>-->
    <!--<script src="./lib/jquery.mobile-1.4.2/jquery.mobile-1.4.2.min.js"></script>-->
    <!--<script src="./lib/moment-with-langs.min.js"></script>-->
    <!--<script src="./lib/roslibjs-devel/include/EventEmitter2/eventemitter2.js"></script>-->
    <!--<script src="./lib/roslibjs-devel/build/roslib.js"></script>-->
    <!--<link rel="stylesheet" href="./lib/jquery.mobile-1.4.2/jquery.mobile-1.4.2.css">-->
    <!--<link rel="stylesheet" href="./lib/jquery.mobile-1.4.2/jquery.mobile.icons-1.4.2.min.css">-->
    <!--<link rel="stylesheet" href="./lib/jquery.mobile-1.4.2/jquery.mobile.structure-1.4.2.min.css">-->

    <script type="text/javascript">
    /*
     * Google Maps documentation: http://code.google.com/apis/maps/documentation/javascript/basics.html
     * Geolocation documentation: http://dev.w3.org/geo/api/spec-source.html
     */

    function listenBackButtonPressed() {
        var r = confirm("Are you sure you want to quit?");
        if(r == true) {
            LifecycleHelper.finishApp();
        }
    }

    $(document).on("pageinit", "#page", function () {
        $.mobile.buttonMarkup.hoverDelay = 500;

        var ros = new ROSLIB.Ros();
        var orderUID; // uid of order
        var orderInfo; // Packed order info; JSON

        var routePointIdx = 0; // Idx for simulation
        var currentMarker;

        var inProgress = false;

        var statusLbs = ["IDLE", "In Progress", "OVER_QUERY_LIMIT", "FAILED"]
        $("#lb-status").html(statusLbs[0]);

        // ------------------------------------------------
        // Event handlers
        // ------------------------------------------------
        $("#btn-order").on("touchstart", function() {
            orderInfo = packOrderMenu();
            if(inProgress == true) {
                alert("Already in progress.");
                return;
            }
            if(orderInfo == undefined || orderInfo == null) {
                alert("No order item exists.");
                return;
            }
            currentMarker.setMap(null);
            routePointIdx = 0;
            inProgress = true;
            $("#lb-status").html(statusLbs[1]);
            calcRoute(routePoints[0], destination, false);
        });
        $(".btn-minus").on("touchstart", function () {
            if(inProgress == true) {
                alert("Already in progress.");
                return;
            }
            numIn = $(this).parent().find("label.lb-quantity");
            num = Number(numIn.html());
            if (num > 0) {
                numIn.html(num - 1);
            }
        });
        $(".btn-plus").on("touchstart", function () {
            if(inProgress == true) {
                alert("Already in progress.");
                return;
            }
            numIn = $(this).parent().find("label.lb-quantity");
            num = Number(numIn.html());
            numIn.html(num + 1);
        });

        // ------------------------------------------------
        // Navigation
        // ------------------------------------------------
        var routePoints = [
            new google.maps.LatLng(37.494579, 126.959767), // Soongsil Univ.
            new google.maps.LatLng(37.495982, 126.953824), // SSU Station
            new google.maps.LatLng(37.502700, 126.947987), // Sangdo Station
            new google.maps.LatLng(37.504964, 126.939275), // Jangseungbaegi Station
            new google.maps.LatLng(37.499687, 126.928074), // Sindaebangsamgeori Station
            new google.maps.LatLng(37.499823, 126.920114), // Boramae Station
            new google.maps.LatLng(37.500027, 126.909943), // Sinpung Station
            new google.maps.LatLng(37.492962, 126.896982), // Daerim Station
            new google.maps.LatLng(37.485998, 126.887176), // Namguro Station
            new google.maps.LatLng(37.480226, 126.882348) // Gasan Digital Station
        ];
        var destination = new google.maps.LatLng(37.476025, 126.882318) // Cafe
        var directionsService = new google.maps.DirectionsService();
        var directionsDisplay = new google.maps.DirectionsRenderer();

//    if (navigator.geolocation) {
//        function success(pos) {
//            // Location found, show map with these coordinates
//            lastLocation = new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
//            drawMap(lastLocation);
//        }
//
//        function fail(error) {
//            drawMap(lastLocation);  // Failed to find location, show default map
//        }
//
//        // Find the users current position.  Cache the location for 5 minutes, timeout after 6 seconds
//        navigator.geolocation.getCurrentPosition(success, fail, {maximumAge: 500000, enableHighAccuracy: true, timeout: 6000});
//    } else {
        drawMap(routePoints[0]);  // No geolocation support, show default map
//    }

        // ------------------------------------------------
        // Functions
        // ------------------------------------------------
        function calcRoute(from, to, isUpdating) {
            var request = {
                origin: from,
                destination: to,
                provideRouteAlternatives: false,
                travelMode: google.maps.TravelMode.TRANSIT
            };

            directionsService.route(request, function (response, status) {
                // Handling OVER_QUERY_LIMIT
//            alert(status);
                if (status == google.maps.DirectionsStatus.OK) {
                    directionsDisplay.setDirections(response);
                    // alert(JSON.stringify(response));
                    // Time Zone: response.routes[0].legs[0].arrival_time.time_zone
                    // Value: response.routes[0].legs[0].arrival_time.value

                    var arrivalTime;
                    if(response.routes[0].legs[0].arrival_time == undefined) {
                        arrivalTime = moment(new Date()).add('minutes', 5);
                    } else {
                        arrivalTime = new Date(response.routes[0].legs[0].arrival_time.value);
                    }

                    if(isUpdating == undefined || isUpdating == false) {
                        order(orderInfo, arrivalTime);
                    } else {
                        updateOrder(arrivalTime);
                    }

                    if(routePointIdx < routePoints.length-1) {
                        setTimeout(function() {
                            calcRoute(routePoints[++routePointIdx], destination, true);
                        }, 7000);
                    } else {
                        // Finish simulation
                        finishSimulation();
                    }

                } else if(status == google.maps.DirectionsStatus.OVER_QUERY_LIMIT) {
//                alert("Over queried. Please wait a minute.");
//                    $("#lb-status").html(statusLbs[2]);
                    setTimeout(function() {
                        $("#lb-status").html(statusLbs[1]);
                        calcRoute(routePoints[routePointIdx], destination, true);
                    }, 3000);
                } else if(status == google.maps.DirectionsStatus.UNKNOWN_ERR) {
                    $("#lb-status").html(statusLbs[3]);
                    finishSimulation();
                }
            });
        }

        function finishSimulation() {
            inProgress = false;
            $("#lb-status").html(statusLbs[0]);
        }

        function packOrderMenu() {
            var order = [];
            var total = 0;
            $("label.lb-quantity").each(function() {
                qty = parseInt($(this).html());
                total += qty;
                order.push({name:$(this).attr("name"), size:2, qty:qty});
            });
            if(total > 0) {
                return order;
            } else {
                return;
            }
        }

        function order(menuItems, expectedArrivalTime) {

            // Display expected arrival time
            ms = moment(expectedArrivalTime).diff(moment(new Date()));
            remainedTime = Math.round(moment.duration(ms).asMinutes());
            $("#arrival-time").attr("value", moment(expectedArrivalTime).format("YYYY-MM-DD HH:mm A"));
            $("#remained-time").attr("value", remainedTime+" minutes");

            // ROS topics and messages
            var orderTopic = new ROSLIB.Topic({
                ros : ros,
                name : '/cafe/remote_order',
                messageType : 'cafe_msgs/RemoteOrder'
            });

            orderUID = guid();
            var orderMsg = new ROSLIB.Message({
                name: orderUID,
                time: moment(new Date()).format("MMDDHHmm"),
                estimated_arrival: parseInt(remainedTime),
                menus: menuItems,
                status: 0
            });

            // Create a connection to the rosbridge WebSocket server.
            serverAddr = $("input#server-addr").val();
            if(serverAddr == undefined || serverAddr == "") {
                ros.connect('ws://localhost:9090');
            } else {
                ros.connect('ws://'+serverAddr);
            }
            orderTopic.publish(orderMsg);


            var orderStatusTopic = new ROSLIB.Topic({
                ros : ros,
                name : '/cafe/remote_order_status',
                messageType : 'cafe_msgs/RemoteOrderStatus'
            });

//            orderStatusTopic.subscribe(function(message) {
////                alert(message.data);
////                listener.unsubscribe();
//            });
        }

        function updateOrder(expectedArrivalTime) {
            ms = moment(expectedArrivalTime).diff(moment(new Date()));
            remainedTime = Math.round(moment.duration(ms).asMinutes());
            $("#arrival-time").attr("value", moment(expectedArrivalTime).format("YYYY-MM-DD HH:mm A"));
            $("#remained-time").attr("value", remainedTime+" minutes");

            // ROS topics and messages
            var orderUpdateTopic = new ROSLIB.Topic({
                ros : ros,
                name : '/cafe/remote_order_update',
                messageType : 'cafe_msgs/RemoteOrderUpdate'
            });

            var orderUpdateMsg = new ROSLIB.Message({
                name: orderUID,
                estimated_arrival: parseInt(remainedTime),
                status: 0
            });

            orderUpdateTopic.publish(orderUpdateMsg);
        }

        function guid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                        .toString(16)
                        .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
                    s4() + '-' + s4() + s4() + s4();
        }

        function drawMap(latlng) {
            var myOptions = {
                zoom: 10,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            var map = new google.maps.Map(document.getElementById("map-canvas"), myOptions);
            directionsDisplay.setMap(map);

            currentMarker = new google.maps.Marker({
                position: latlng,
                map: map,
                title: "Greetings!"
            });
            currentMarker.setMap(map);
        }

        function pad(num, size) {
            var s = num+"";
            while (s.length < size) s = "0" + s;
            return s;
        }
    });
    </script>

    <style>
        #page {
            height: 100%;
            padding: 0;
        }

        #map-canvas {
            width: 100%;
            height: 300px;
        }

        ul.list-hor {
            list-style: none;
            width: 100%;
            display: block;
        }

        ul.list-hor > li {
            width: 200px;
            list-style: none;
            float: left;
        }

        .menuitem {
            width: 100%;
        }

        div.menuitem-blk {
            text-align: center;
            font-weight: bold;
        }

        label.lb-quantity {
            width: 40px;
            padding: 10px;
            text-align: center;
            line-height: 50px;
        }

        .hor-children > * {
            float: left;
        }

        .btn-minus, .btn-plus {
            margin-left: 10px;
            margin-right: 10px;
            padding: 10px;
        }

        #lb-status {
            font-weight: bold;
        }
    </style>

</head>
<body>
<div data-role="page" id="page" data-url="page">
    <div data-role="header" data-theme="b">
        <h1>Cafe Remote Order App</h1>
    </div>
    <div>
        <div style="float: left; width: 65%;">
            <div class="ui-bar ui-bar-a">
                <h3>Map</h3>
            </div>
            <div role="main" class="ui-content" id="map-canvas" style="padding:0px;">
                <!-- map loads here... -->
            </div>
        </div>
        <div class="ui-corner-all custom-corners" style="float: right; width: 35%;">
            <div class="ui-bar ui-bar-a">
                <h3>Expectation</h3>
            </div>
            <div role="main" class="ui-content">
                <div>
                    <label>Arrival Time:</label><input readonly="readonly" id="arrival-time">
                    <label>Remained Time:</label><input readonly="readonly" id="remained-time">
                </div>
            </div>
            <div class="ui-bar ui-bar-a">
                <h3>Status</h3>
            </div>
            <div role="main" class="ui-content">
                <label id="lb-status"></label>
            </div>
        </div>
    </div>
    <div class="ui-corner-all custom-corners">
        <div class="ui-bar ui-bar-a">
            <h3>Menu</h3>
        </div>
        <ul data-role="listview" data-inset="true">
            <li data-icon="false">
                <img src="file:///android_asset/web/res/americano.png">

                <div style="float:left">
                    <h2>Americano</h2>

                    <p>2,000 won</p>
                </div>
                <div style="float:right">
                    <div class="ui-nodisc-icon hor-children"><!-- Class added to the wrapper -->
                        <a href="#"
                           class="btn-minus ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline">Minus</a>
                        <label class="lb-quantity" name="Americano">0</label>
                        <a href="#"
                           class="btn-plus ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a>
                    </div>
                </div>
            </li>
            <li data-icon="false">
                <img src="file:///android_asset/web/res/iced-americano.png">

                <div style="float:left">
                    <h2>Iced Americano</h2>

                    <p>2,500 won</p>
                </div>
                <div style="float:right">
                    <div class="ui-nodisc-icon hor-children"><!-- Class added to the wrapper -->
                        <a href="#"
                           class="btn-minus ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline">Minus</a>
                        <label class="lb-quantity" name="Iced Americano">0</label>
                        <a href="#"
                           class="btn-plus ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a>
                    </div>
                </div>

            </li>
            <li data-icon="false">
                <img src="file:///android_asset/web/res/cafe-latte.png">

                <div style="float:left">
                    <h2>Latte</h2>

                    <p>2,500 won</p>
                </div>
                <div style="float:right">
                    <div class="ui-nodisc-icon hor-children"><!-- Class added to the wrapper -->
                        <a href="#"
                           class="btn-minus ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline">Minus</a>
                        <label class="lb-quantity" name="Latte">0</label>
                        <a href="#"
                           class="btn-plus ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a>
                    </div>
                </div>
            </li>
            <li data-icon="false">
                <img src="file:///android_asset/web/res/iced_cafe-latte.png">

                <div style="float:left">
                    <h2>Iced Latte</h2>

                    <p>3,000 won</p>
                </div>
                <div style="float:right">
                    <div class="ui-nodisc-icon hor-children"><!-- Class added to the wrapper -->
                        <a href="#"
                           class="btn-minus ui-btn ui-shadow ui-corner-all ui-icon-minus ui-btn-icon-notext ui-btn-b ui-btn-inline">Minus</a>
                        <label class="lb-quantity" name="Iced Latte">0</label>
                        <a href="#"
                           class="btn-plus ui-btn ui-shadow ui-corner-all ui-icon-plus ui-btn-icon-notext ui-btn-b ui-btn-inline">Plus</a>
                    </div>
                </div>
            </li>
        </ul>

        <!--div class="ui-body ui-body-a">
            <ul class="list-hor">
                <li><div class="menuitem-blk"><img class="menuitem" src="file:///android_asset/web/res/americano.png"><br>Americano</div></li>
                <li><div class="menuitem-blk"><img class="menuitem" src="file:///android_asset/web/res/iced-americano.png"><br>Iced Americano</div></li>
                <li><div class="menuitem-blk"><img class="menuitem" src="file:///android_asset/web/res/cafe-latte.png"><br>Latte</div></li>
                <li><div class="menuitem-blk"><img class="menuitem" src="file:///android_asset/web/res/iced_cafe-latte.png"><br>Iced Latte</div></li>
            </ul>
        </div-->
    </div>
    <div>
        <div style="float: left; width: 70%; padding: 1%;">
            <input id="server-addr" placeholder="Server Address (Do not put any protocol prefix like 'http')">
        </div>
        <div style="float: right; width: 25%; padding: 1%;">
            <button class="ui-btn" id="btn-order">Order</button>
        </div>
    </div>

</div>

</body>
</html>